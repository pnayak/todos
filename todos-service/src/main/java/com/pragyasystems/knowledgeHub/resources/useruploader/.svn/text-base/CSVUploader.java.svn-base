package csvuploader;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;

/**
 * This will upload CSV file to database.
 * 
 * @author durgesh.yadav
 *
 */
public class CSVUploader {
	
	private InputStream inputStream;
	private int rowsInserted = 0;
	/**
	 * 
	 * @param inputStream CSV file inputstream
	 * @param consumerService Used to store CSV file data into DB
	 */
	public CSVUploader(InputStream inputStream) {
		this.inputStream = inputStream;
	}
	
	public CSVUploader(File file) {
		try {
			this.inputStream = new FileInputStream(file);
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		}
	}

	/**
	 * This method will upload CSV file to DB. Erroneous line in CSV file will be ignored silently.
	 * @return {@link List} of errors in CSVfile
	 */
	public List<String> upload(int teamId) {
		List<String> errors = new ArrayList<String>();
			try {
				// Create new Reader
				BufferedReader br = new BufferedReader(new InputStreamReader(inputStream));
				String line = null;
				int lineNo = 1;
				// Get CSV file line
				while ((line = br.readLine()) != null) {
                                    String[] userProp = line.split(",");
                                    for (int i = 0; i < userProp.length; i++) {
					userProp[i] = userProp[i].trim();
				}
                                    
					// Pass this line to Validator
					String validatorRes = CSVValidator.getError(userProp, lineNo);
					
					// If Response code is error code, ignore this line and go to next line
					if (validatorRes != null) {
						errors.add(validatorRes);
					} else {
						CSVUploaderUtil.saveCSVFields(teamId, userProp);
					}
					lineNo++;
				}
			} catch (Exception e) {
				errors.add(e.getMessage());
			}
		return errors;
	}

	public int getRowsInserted() {
		return rowsInserted;
	}
		
	
	
}
